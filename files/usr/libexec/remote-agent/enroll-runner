#!/bin/sh
# Runs a single enrollment attempt (or flips to discoverable mode if no URL is found)
set -e

readonly raFunctions='/usr/lib/remote-agent/functions.sh'
if [ -s "$raFunctions" ]; then
# shellcheck source=../../lib/remote-agent/functions.sh
	. "$raFunctions"
else
	logger -t 'remote-agent' 'error' "Remote-Agent Functions file ($raFunctions) not found!"
fi

wait_for_net

URL="$(controller_url)"
if [ -n "$URL" ]; then
	DATA="$(payload)"
	RESP="$(post_json "$URL" "$DATA" || true)"
	if [ -n "$RESP" ]; then
		rotate_to_shadow_local "$RESP"
		exit 0
	fi
fi

enable_discoverable
sleep "$(uci -q get remote_agent.interval || echo 300)"
exit 0
