#!/bin/sh
# Implements list|call and supports discoverable adoption.
set -e

readonly raFunctions='/usr/lib/remote-agent/functions.sh'
if [ -s "$raFunctions" ]; then
# shellcheck source=../../lib/remote-agent/functions.sh
	. "$raFunctions"
else
	logger -t 'remote-agent' 'error' "Remote-Agent Functions file ($raFunctions) not found!"
fi

case "$1" in
  list)
    {
      echo '{'
      echo '"_core":'
      core_list
      for s in "$EXT_DIR"/*; do
        [ -x "$s" ] || continue
        echo ',"_ext_'"$(basename "$s")"'":'
        "$s" list 2>/dev/null || echo '{}'
      done
      echo '}'
    }
    ;;
  call)
    m="$2"
    read_stdin
    case "$m" in
      ping) jout '{"ok":true,"name":"provision"}' ;;
      reboot) do_reboot ;;
      passwd) do_passwd ;;
      uci) do_uci ;;
      service) do_service ;;
      wifi) do_wifi ;;
      pkg) do_pkg ;;
      bootstrap_info) do_bootstrap_info ;;
      adopt) do_adopt ;;
      *) if ! ext_call "$m"; then err "unknown method"; fi ;;
    esac
    ;;
  *) echo "Usage: $0 list|call <method>" >&2; exit 2 ;;
esac
