#!/usr/bin/ucode -R
'use strict';

function ok(obj) { return { code: 0, data: obj }; }

let M = {};

M["remote.agent"] = {
	"capabilities.list": function (req) {
		return ok({ enrollment: true, report: true, session_pull_only: true });
	},
	"session_pull_only": function (req) {
		let val = req && (req.enable === true || req.enable === 1) ? 1 : 0;
		// Transient change could be stored in /tmp, but for MVP we just echo
		return ok({ applied: true, persisted: false, value: val });
	},
	"report.get": function (req) {
		let device_id = (fs.readfile("/etc/remote-agent/uuid") || "").trim();
		let now = new (Date()).toISOString();
		// TODO: collect real data via ubus/iwinfo
		let payload = {
			schema_version: "1.0",
			agent_version: "remote-agent 0.1.0",
			device_id: device_id,
			ts: now,
			system: { hostname: "openwrt", uptime_s: 0, board: "", release: "", kernel: "", pkgmgr: {opkg:true, apk:false} },
			interfaces: [],
			wifi: [],
			warnings: [],
			errors: []
		};
		return ok(payload);
	}
};

rpcd.register_object(M);
